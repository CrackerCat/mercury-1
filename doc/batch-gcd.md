# Batch GCD utility

The `batch_gcd` utility is designed to detect whether a set of RSA keys has any
pairs of moduli that share a common factor. This could happen, for example, if
some of the moduli were generated by the same weak entropy source.

## Contents

* [Quick Start](#quick-start)
* [Build Instructions](#build-instructions)
* [Capabilities and Limitations](#capabilities-and-limitations)

## Quick Start

The `batch_gcd` command line tool takes a list of hex integers on stdin (one per
line), and efficiently computes the greatest common divisor (GCD) on all pairs
of inputs.  It writes to stdout any non-trivial common factors, followed by the
sets of line numbers that share a common factor.  Informational messages are
written to stderr.
```
$ ./configure
$ make batch_gcd --dir=src
$ echo -e "29bf7\n12a15\n17b6d" | src/batch_gcd
Running batch GCD on 3 moduli.
Parallelization: 12 threads
Found 3 weak moduli out of 3.
Computing pairwise GCD for 1 moduli, estimated time: O(3 * 1)
Further found co-factors for 1 weak moduli.
Vulnerable modulus on line 1: 29bf7 has factors 133 and 22d
Vulnerable modulus on line 2: 12a15 has factors 89 and 22d
Vulnerable modulus on line 3: 17b6d has factors 89 and 2c5
Reporting which lines, if any, share a common factor.
2,3;1,2
$ echo -e "29bf7\n12a15\n17b6d" | src/batch_gcd 2> /dev/null
Vulnerable modulus on line 1: 29bf7 has factors 133 and 22d
Vulnerable modulus on line 2: 12a15 has factors 89 and 22d
Vulnerable modulus on line 3: 17b6d has factors 89 and 2c5
2,3;1,2
```

## Build Instructions

The `batch_gcd` tool is not built by default, because it depends on the GNU
Multiple Precision Arithmetic Library (GMP).  To build it manually, run the
following commands from the top-level directory of the `mercury-transition`
source repository.
```
$ ./configure
$ make batch_gcd --dir=src
$ make batch_gcd_test --dir=test   # run tests (optional)
```
The executable will be built at the path `src/batch_gcd`.

## Capabilities and Limitations

This tool is designed for computing batch GCD on a very large set of integers,
using the approach taken by [Heninger et. al
(2012)](https://www.usenix.org/conference/usenixsecurity12/technical-sessions/presentation/heninger).
Currently, `batch_gcd` can handle up to roughly 67 million 2048-bit RSA moduli,
given a machine with sufficient memory of about 1 TB of RAM, and it
automatically parallelizes the computation across all CPU cores.  The current
input size limit is due to the fact that the batch GCD algorithm multiplies all
of the input together into one large integer, and the largest single integer
that GMP can represent is 2^37 bits, or about 16 GB (details
[here](https://gmplib.org/list-archives/gmp-bugs/2009-July/001538.html) and
[here](https://gmplib.org/gmp6.0)).  If the input size exceeds this limit,
the tool aborts with an error message.
